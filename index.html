<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa de Atividades AcadÃªmicas â€” Ensino Â· Pesquisa Â· ExtensÃ£o</title>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@500;700&family=DM+Sans:ital,wght@0,400;0,500;0,700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='48' height='48' fill='none'><rect x='4' y='18' width='16' height='38' rx='3' fill='%23e94560' opacity='0.85'/><rect x='4' y='10' width='16' height='10' rx='3' fill='%23ff6b81'/><rect x='24' y='24' width='16' height='32' rx='3' fill='%234a90d9' opacity='0.85'/><rect x='24' y='10' width='16' height='16' rx='3' fill='%236aaee8'/><rect x='44' y='20' width='16' height='36' rx='3' fill='%238854d0' opacity='0.85'/><rect x='44' y='10' width='16' height='12' rx='3' fill='%23a070e0'/><rect x='6' y='12' width='12' height='6' rx='2' fill='white' opacity='0.3'/><rect x='26' y='12' width='12' height='6' rx='2' fill='white' opacity='0.3'/><rect x='46' y='12' width='12' height='6' rx='2' fill='white' opacity='0.3'/></svg>">
<style>
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --ensino: #e94560;
    --pesquisa: #0f3460;
    --extensao: #533483;
    --ensino-light: #ff6b81;
    --pesquisa-light: #4a90d9;
    --extensao-light: #8854d0;
    --text: #eaeaea;
    --text-muted: #a0a0b8;
    --card-shadow: 0 4px 24px rgba(0,0,0,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(circle at 20% 20%, rgba(233,69,96,0.06) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(83,52,131,0.06) 0%, transparent 50%),
      radial-gradient(circle at 50% 50%, rgba(15,52,96,0.08) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: relative; z-index: 1;
    text-align: center;
    padding: 2rem 1rem 0.6rem;
  }
  header h1 {
    font-family: 'Playfair Display', serif;
    font-weight: 900;
    font-size: clamp(1.8rem, 5vw, 3rem);
    background: linear-gradient(135deg, var(--ensino-light), var(--pesquisa-light), var(--extensao-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  header p {
    color: var(--text-muted);
    margin-top: 0.3rem;
    font-size: 0.88rem;
  }

  .main-layout {
    position: relative; z-index: 1;
    max-width: 1300px;
    margin: 0 auto;
    padding: 1rem;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STAGING AREA
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .staging-section {
    background: var(--surface);
    border-radius: 18px;
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(255,255,255,0.06);
    margin-bottom: 1.5rem;
    overflow: hidden;
    transition: box-shadow 0.3s;
  }
  .staging-section.drag-over {
    box-shadow: 0 0 0 3px rgba(74,144,217,0.35), var(--card-shadow);
  }

  .staging-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.6rem;
    padding: 1rem 1.4rem;
    background: linear-gradient(135deg, rgba(42,58,92,0.5), rgba(28,42,74,0.7));
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .staging-top h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.15rem;
    display: flex; align-items: center; gap: 0.5rem;
  }
  .badge {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.68rem; font-weight: 700;
    background: rgba(255,255,255,0.1);
    padding: 0.18rem 0.5rem;
    border-radius: 20px;
    color: var(--text-muted);
  }
  .staging-btns {
    display: flex; gap: 0.4rem; flex-wrap: wrap;
  }

  .creation-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.7rem;
    align-items: flex-end;
    padding: 1.1rem 1.4rem;
    background: rgba(0,0,0,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .field {
    display: flex; flex-direction: column; gap: 0.22rem;
  }
  .field label {
    font-size: 0.7rem; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.06em;
  }
  .field input[type="text"], .field select {
    padding: 0.48rem 0.65rem;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.3);
    color: #fff;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .field input:focus, .field select:focus { border-color: var(--pesquisa-light); }

  .char-count { font-size: 0.63rem; color: var(--text-muted); text-align: right; margin-top: 1px; }
  .char-count.warn { color: var(--ensino); }

  .color-picker-row { display: flex; gap: 5px; align-items: center; }
  .color-swatch {
    width: 23px; height: 23px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
  }
  .color-swatch:hover, .color-swatch.selected {
    transform: scale(1.2);
    border-color: #fff;
    box-shadow: 0 0 8px rgba(255,255,255,0.3);
  }

  .file-label {
    display: inline-flex; align-items: center; gap: 0.4rem;
    padding: 0.48rem 0.85rem;
    border-radius: 8px;
    border: 2px dashed rgba(255,255,255,0.15);
    background: rgba(0,0,0,0.2);
    color: var(--text-muted);
    cursor: pointer; font-size: 0.8rem;
    transition: all 0.2s;
  }
  .file-label:hover { border-color: var(--pesquisa-light); color: #fff; }
  .file-label input { display: none; }
  .file-name {
    font-size: 0.7rem; color: var(--text-muted);
    max-width: 110px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }

  .divider {
    width: 1px; height: 34px;
    background: rgba(255,255,255,0.08);
    align-self: center; margin: 0 0.2rem;
  }

  .btn {
    padding: 0.48rem 1.1rem; border: none; border-radius: 9px;
    font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 0.78rem;
    cursor: pointer; transition: all 0.25s;
    text-transform: uppercase; letter-spacing: 0.04em;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--ensino), var(--extensao));
    color: #fff;
    box-shadow: 0 3px 12px rgba(233,69,96,0.3);
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 5px 20px rgba(233,69,96,0.45); }

  .btn-ghost {
    padding: 0.4rem 0.8rem;
    border: 1px solid rgba(255,255,255,0.12);
    background: transparent;
    color: var(--text-muted);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-weight: 500; font-size: 0.72rem;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-ghost:hover { background: rgba(255,255,255,0.06); color: #fff; }
  .btn-ghost.import-label { cursor: pointer; }
  .btn-ghost.import-label:hover { background: rgba(255,255,255,0.06); color: #fff; }
  .btn-danger { border-color: rgba(233,69,96,0.25); color: var(--ensino-light); }
  .btn-danger:hover { background: rgba(233,69,96,0.12); }

  .staging-body {
    padding: 1rem 1.4rem 1.1rem;
    display: flex; flex-wrap: wrap;
    align-content: flex-start;
    gap: 0.7rem;
    min-height: 100px;
    transition: background 0.25s;
  }
  .staging-body.drag-over { background: rgba(74,144,217,0.05); }

  .staging-body:empty::after {
    content: 'ğŸ“‹ Crie post-its e imagens acima â€” eles aparecerÃ£o aqui para uso em aula';
    display: flex; align-items: center; justify-content: center;
    width: 100%; min-height: 70px;
    color: rgba(255,255,255,0.13);
    font-size: 0.82rem; font-style: italic;
    border: 2px dashed rgba(255,255,255,0.06);
    border-radius: 12px;
    text-align: center; padding: 0.8rem;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TIER COLUMNS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .tier-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }
  @media (max-width: 820px) {
    .tier-container { grid-template-columns: 1fr; max-width: 480px; margin: 0 auto; }
    .creation-bar { flex-direction: column; align-items: stretch; }
    .divider { display: none; }
  }

  .tier-column {
    background: var(--surface);
    border-radius: 18px;
    overflow: hidden;
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(255,255,255,0.05);
    min-height: 340px;
    display: flex; flex-direction: column;
    transition: box-shadow 0.3s;
  }
  .tier-column.drag-over {
    box-shadow: 0 0 0 3px rgba(255,255,255,0.25), var(--card-shadow);
  }

  .tier-header {
    padding: 0.95rem 1.1rem;
    text-align: center;
    position: relative; overflow: hidden;
  }
  .tier-header::before {
    content: ''; position: absolute; inset: 0; opacity: 0.15;
    background: repeating-linear-gradient(-45deg, transparent, transparent 8px, rgba(255,255,255,0.05) 8px, rgba(255,255,255,0.05) 16px);
  }
  .tier-column[data-tier="ensino"] .tier-header { background: var(--ensino); }
  .tier-column[data-tier="pesquisa"] .tier-header { background: var(--pesquisa); }
  .tier-column[data-tier="extensao"] .tier-header { background: var(--extensao); }

  .tier-header h3 {
    font-family: 'Playfair Display', serif;
    font-weight: 900; font-size: 1.2rem;
    position: relative;
  }
  .tier-header .icon { font-size: 1.3rem; margin-bottom: 0.1rem; display: block; }
  .tier-header .count {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.68rem; font-weight: 500;
    opacity: 0.7; margin-top: 0.15rem; position: relative;
  }

  .tier-body {
    flex: 1; padding: 0.85rem;
    display: flex; flex-wrap: wrap;
    align-content: flex-start;
    gap: 0.65rem;
    min-height: 240px;
  }
  .tier-body:empty::after {
    content: 'Arraste itens aqui';
    display: flex; align-items: center; justify-content: center;
    width: 100%; height: 100%; min-height: 170px;
    color: rgba(255,255,255,0.1);
    font-size: 0.82rem; font-style: italic;
    border: 2px dashed rgba(255,255,255,0.06);
    border-radius: 12px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     POST-IT & IMAGE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .postit {
    position: relative;
    width: 118px; min-height: 94px;
    padding: 0.6rem 0.5rem 1.4rem;
    border-radius: 2px;
    cursor: grab;
    display: flex; align-items: center; justify-content: center;
    text-align: center;
    box-shadow: 2px 3px 8px rgba(0,0,0,0.25), inset 0 -2px 6px rgba(0,0,0,0.06);
    transform: rotate(var(--rotation, 0deg));
    transition: transform 0.2s, box-shadow 0.2s;
    animation: itemDrop 0.3s ease-out;
    user-select: none; flex-shrink: 0;
  }
  .postit:hover {
    transform: rotate(0deg) scale(1.08);
    box-shadow: 4px 6px 20px rgba(0,0,0,0.35);
    z-index: 10;
  }
  .postit:active { cursor: grabbing; }
  .postit::before {
    content: ''; position: absolute;
    top: -6px; left: 50%; transform: translateX(-50%);
    width: 36px; height: 12px;
    background: rgba(255,255,255,0.35);
    border-radius: 1px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .postit-text {
    font-family: 'Caveat', cursive;
    font-weight: 700; font-size: 1.05rem; line-height: 1.2;
    color: #2d2d2d;
    word-break: break-word; hyphens: auto;
  }

  .delete-btn {
    position: absolute;
    width: 19px; height: 19px;
    border-radius: 50%; border: none;
    background: rgba(0,0,0,0.15);
    color: rgba(0,0,0,0.4);
    font-size: 0.62rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s;
  }
  .postit .delete-btn { bottom: 3px; right: 3px; }
  .postit:hover .delete-btn, .tier-image:hover .delete-btn { opacity: 1; }
  .delete-btn:hover { background: rgba(200,0,0,0.3) !important; color: rgba(180,0,0,0.8) !important; }

  .tier-image {
    position: relative;
    width: 102px; height: 102px;
    border-radius: 10px; overflow: hidden;
    cursor: grab;
    box-shadow: 0 3px 12px rgba(0,0,0,0.35);
    transition: transform 0.2s, box-shadow 0.2s;
    animation: itemDrop 0.3s ease-out;
    user-select: none; flex-shrink: 0;
  }
  .tier-image:hover { transform: scale(1.08); box-shadow: 0 6px 24px rgba(0,0,0,0.5); z-index: 10; }
  .tier-image:active { cursor: grabbing; }
  .tier-image img { width: 100%; height: 100%; object-fit: cover; }
  .tier-image .delete-btn { top: 3px; right: 3px; background: rgba(0,0,0,0.55); color: #fff; }

  .dragging { opacity: 0.3; }

  @keyframes itemDrop {
    0% { opacity: 0; transform: rotate(var(--rotation, 0deg)) translateY(-14px) scale(0.85); }
    100% { opacity: 1; transform: rotate(var(--rotation, 0deg)) translateY(0) scale(1); }
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }

  .footer {
    text-align: center; padding: 1.3rem 1rem 1rem;
    color: var(--text-muted); font-size: 0.7rem; opacity: 0.4;
    position: relative; z-index: 1;
  }
</style>
</head>
<body>

<header>
  <h1>Tier List AcadÃªmica</h1>
  <p>Prepare os itens no banco e, durante a aula, arraste-os para as categorias com a turma</p>
</header>

<div class="main-layout">

  <!-- â•â•â•â•â•â•â•â•â•â• STAGING AREA â•â•â•â•â•â•â•â•â•â• -->
  <section class="staging-section">
    <div class="staging-top">
      <h2>ğŸ’ Banco de Itens <span class="badge" id="staging-count">0 itens</span></h2>
      <div class="staging-btns">
        <button class="btn-ghost" id="collapse-btn" title="Recolher formulÃ¡rio">â–² Recolher</button>
        <button class="btn-ghost" id="export-btn" title="Exportar estado">ğŸ“¤ Exportar</button>
        <label class="btn-ghost import-label" id="import-label" title="Importar estado">
          ğŸ“¥ Importar
          <input type="file" id="import-input" accept=".json" style="display:none">
        </label>
        <button class="btn-ghost btn-danger" id="clear-all-btn">ğŸ—‘ Limpar tudo</button>
      </div>
    </div>

    <div id="creation-area">
      <div class="creation-bar">
        <div class="field" style="flex:1; min-width:155px;">
          <label for="postit-input">ğŸ“ Texto do Post-it</label>
          <input type="text" id="postit-input" maxlength="25" placeholder="Ex: Aula de CÃ¡lculo">
          <div class="char-count"><span id="char-current">0</span>/25</div>
        </div>
        <div class="field">
          <label>Cor</label>
          <div class="color-picker-row" id="color-picker">
            <div class="color-swatch selected" data-color="#ffe066" style="background:#ffe066;" title="Amarelo"></div>
            <div class="color-swatch" data-color="#a8e6cf" style="background:#a8e6cf;" title="Verde"></div>
            <div class="color-swatch" data-color="#ffaaa5" style="background:#ffaaa5;" title="Rosa"></div>
            <div class="color-swatch" data-color="#a0d2db" style="background:#a0d2db;" title="Azul"></div>
            <div class="color-swatch" data-color="#ffcc80" style="background:#ffcc80;" title="Laranja"></div>
            <div class="color-swatch" data-color="#d5aaff" style="background:#d5aaff;" title="LilÃ¡s"></div>
          </div>
        </div>
        <button class="btn btn-primary" id="add-postit-btn">+ Post-it</button>
        <div class="divider"></div>
        <div class="field">
          <label>ğŸ–¼ï¸ Imagem</label>
          <label class="file-label">
            ğŸ“ Arquivo
            <input type="file" id="img-input" accept="image/*">
          </label>
          <span class="file-name" id="file-name-display">Nenhum arquivo</span>
        </div>
        <button class="btn btn-primary" id="add-img-btn">+ Imagem</button>
      </div>
    </div>

    <div class="staging-body" id="staging-pool"></div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â• TIER COLUMNS â•â•â•â•â•â•â•â•â•â• -->
  <div class="tier-container">
    <div class="tier-column" data-tier="ensino">
      <div class="tier-header">
        <span class="icon">ğŸ“š</span>
        <h3>Ensino</h3>
        <div class="count" id="count-ensino">0 itens</div>
      </div>
      <div class="tier-body drop-zone" id="tier-ensino"></div>
    </div>
    <div class="tier-column" data-tier="pesquisa">
      <div class="tier-header">
        <span class="icon">ğŸ”¬</span>
        <h3>Pesquisa</h3>
        <div class="count" id="count-pesquisa">0 itens</div>
      </div>
      <div class="tier-body drop-zone" id="tier-pesquisa"></div>
    </div>
    <div class="tier-column" data-tier="extensao">
      <div class="tier-header">
        <span class="icon">ğŸ¤</span>
        <h3>ExtensÃ£o</h3>
        <div class="count" id="count-extensao">0 itens</div>
      </div>
      <div class="tier-body drop-zone" id="tier-extensao"></div>
    </div>
  </div>
</div>

<div class="footer">Arraste itens do banco para as categorias Â· Itens podem voltar ao banco Â· Dados salvos automaticamente</div>

<script>
(() => {
  const STORAGE_KEY = 'tierlist-academica-v2';
  const ALL_ZONES = ['staging-pool', 'tier-ensino', 'tier-pesquisa', 'tier-extensao'];

  // â”€â”€ Collapse â”€â”€
  const creationArea = document.getElementById('creation-area');
  const collapseBtn = document.getElementById('collapse-btn');
  let collapsed = false;
  collapseBtn.addEventListener('click', () => {
    collapsed = !collapsed;
    creationArea.style.display = collapsed ? 'none' : '';
    collapseBtn.textContent = collapsed ? 'â–¼ Expandir' : 'â–² Recolher';
  });

  // â”€â”€ Color Picker â”€â”€
  let selectedColor = '#ffe066';
  document.getElementById('color-picker').addEventListener('click', e => {
    const sw = e.target.closest('.color-swatch');
    if (!sw) return;
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
    sw.classList.add('selected');
    selectedColor = sw.dataset.color;
  });

  // â”€â”€ Char Counter â”€â”€
  const postitInput = document.getElementById('postit-input');
  const charCurrent = document.getElementById('char-current');
  postitInput.addEventListener('input', () => {
    const len = postitInput.value.length;
    charCurrent.textContent = len;
    charCurrent.parentElement.classList.toggle('warn', len >= 22);
  });

  function randomRotation() { return (Math.random() - 0.5) * 6; }

  function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function updateCounts() {
    const sc = document.getElementById('staging-pool').children.length;
    document.getElementById('staging-count').textContent = sc + (sc === 1 ? ' item' : ' itens');
    ['ensino', 'pesquisa', 'extensao'].forEach(id => {
      const n = document.getElementById('tier-' + id).children.length;
      document.getElementById('count-' + id).textContent = n + (n === 1 ? ' item' : ' itens');
    });
  }

  // â•â•â• localStorage â•â•â•
  function saveState() {
    const data = {};
    ALL_ZONES.forEach(zid => {
      const zone = document.getElementById(zid);
      const items = [];
      zone.querySelectorAll('.postit, .tier-image').forEach(el => {
        if (el.classList.contains('postit')) {
          items.push({ type: 'postit', text: el.querySelector('.postit-text').textContent, color: el.style.background, rotation: el.style.getPropertyValue('--rotation') });
        } else if (el.classList.contains('tier-image')) {
          items.push({ type: 'image', src: el.querySelector('img').src });
        }
      });
      data[zid] = items;
    });
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); showToast('âœ“ Salvo'); }
    catch (e) { console.warn('Save error:', e); }
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      ALL_ZONES.forEach(zid => {
        const items = data[zid];
        if (!Array.isArray(items)) return;
        items.forEach(item => {
          if (item.type === 'postit') addPostitToZone(item.text, item.color, zid, item.rotation, false);
          else if (item.type === 'image') addImageToZone(item.src, zid, false);
        });
      });
      updateCounts();
    } catch (e) { console.warn('Load error:', e); }
  }

  function clearAll() {
    if (!confirm('Limpar todos os itens do banco e das categorias?')) return;
    localStorage.removeItem(STORAGE_KEY);
    ALL_ZONES.forEach(id => { document.getElementById(id).innerHTML = ''; });
    updateCounts();
  }

  function showToast(msg) {
    let t = document.getElementById('save-toast');
    if (!t) {
      t = document.createElement('div');
      t.id = 'save-toast';
      t.style.cssText = 'position:fixed;bottom:1.2rem;right:1.2rem;background:rgba(22,33,62,0.92);color:#a8e6cf;padding:0.42rem 0.95rem;border-radius:9px;font-family:"DM Sans",sans-serif;font-size:0.76rem;font-weight:500;box-shadow:0 4px 16px rgba(0,0,0,0.4);border:1px solid rgba(168,230,207,0.2);z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity = '1';
    clearTimeout(t._t);
    t._t = setTimeout(() => { t.style.opacity = '0'; }, 1400);
  }

  // â•â•â• Create Items â•â•â•
  function addPostitToZone(text, color, zoneId, rotation, shouldSave = true) {
    if (!text.trim()) return;
    const zone = document.getElementById(zoneId);
    const note = document.createElement('div');
    note.className = 'postit';
    note.draggable = true;
    note.style.background = color;
    note.style.setProperty('--rotation', rotation || (randomRotation() + 'deg'));
    note.innerHTML = `<span class="postit-text">${escapeHtml(text)}</span><button class="delete-btn" title="Remover">âœ•</button>`;
    note.querySelector('.delete-btn').addEventListener('click', e => { e.stopPropagation(); note.remove(); updateCounts(); saveState(); });
    addDragEvents(note);
    zone.appendChild(note);
    if (shouldSave) { updateCounts(); saveState(); }
  }

  function addImageToZone(src, zoneId, shouldSave = true) {
    const zone = document.getElementById(zoneId);
    const item = document.createElement('div');
    item.className = 'tier-image';
    item.draggable = true;
    item.innerHTML = `<img src="${src}" alt="Item"><button class="delete-btn" title="Remover">âœ•</button>`;
    item.querySelector('.delete-btn').addEventListener('click', e => { e.stopPropagation(); item.remove(); updateCounts(); saveState(); });
    addDragEvents(item);
    zone.appendChild(item);
    if (shouldSave) { updateCounts(); saveState(); }
  }

  // â”€â”€ Buttons â†’ staging pool â”€â”€
  document.getElementById('add-postit-btn').addEventListener('click', () => {
    const text = postitInput.value.trim();
    if (!text) { postitInput.focus(); return; }
    addPostitToZone(text, selectedColor, 'staging-pool');
    postitInput.value = '';
    charCurrent.textContent = '0';
    charCurrent.parentElement.classList.remove('warn');
    postitInput.focus();
  });
  postitInput.addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('add-postit-btn').click(); });

  const imgInput = document.getElementById('img-input');
  const fileNameDisplay = document.getElementById('file-name-display');
  imgInput.addEventListener('change', () => { fileNameDisplay.textContent = imgInput.files[0]?.name || 'Nenhum arquivo'; });
  document.getElementById('add-img-btn').addEventListener('click', () => {
    const file = imgInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => { addImageToZone(e.target.result, 'staging-pool'); imgInput.value = ''; fileNameDisplay.textContent = 'Nenhum arquivo'; };
    reader.readAsDataURL(file);
  });

  document.getElementById('clear-all-btn').addEventListener('click', clearAll);

  // â•â•â• Export / Import â•â•â•
  function buildStateData() {
    const data = {};
    ALL_ZONES.forEach(zid => {
      const zone = document.getElementById(zid);
      const items = [];
      zone.querySelectorAll('.postit, .tier-image').forEach(el => {
        if (el.classList.contains('postit')) {
          items.push({ type: 'postit', text: el.querySelector('.postit-text').textContent, color: el.style.background, rotation: el.style.getPropertyValue('--rotation') });
        } else if (el.classList.contains('tier-image')) {
          items.push({ type: 'image', src: el.querySelector('img').src });
        }
      });
      data[zid] = items;
    });
    return data;
  }

  function exportState() {
    const data = buildStateData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const now = new Date();
    const stamp = now.toISOString().slice(0,16).replace('T','_').replace(':','-');
    a.href = url;
    a.download = `tierlist_${stamp}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('ğŸ“¤ Exportado com sucesso');
  }

  function importState(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        // Validate structure
        const validKeys = ALL_ZONES;
        const hasValid = validKeys.some(k => Array.isArray(data[k]));
        if (!hasValid) { showToast('âš ï¸ Arquivo invÃ¡lido'); return; }
        if (!confirm('Importar substituirÃ¡ o estado atual. Continuar?')) return;
        ALL_ZONES.forEach(id => { document.getElementById(id).innerHTML = ''; });
        ALL_ZONES.forEach(zid => {
          const items = data[zid];
          if (!Array.isArray(items)) return;
          items.forEach(item => {
            if (item.type === 'postit') addPostitToZone(item.text, item.color, zid, item.rotation, false);
            else if (item.type === 'image') addImageToZone(item.src, zid, false);
          });
        });
        updateCounts();
        saveState();
        showToast('ğŸ“¥ Importado com sucesso');
      } catch (err) {
        showToast('âš ï¸ Erro ao importar');
        console.error('Import error:', err);
      }
    };
    reader.readAsText(file);
  }

  document.getElementById('export-btn').addEventListener('click', exportState);

  const importInput = document.getElementById('import-input');
  importInput.addEventListener('change', () => {
    importState(importInput.files[0]);
    importInput.value = '';
  });

  // â•â•â• Drag & Drop â•â•â•
  let draggedEl = null;

  function addDragEvents(el) {
    el.addEventListener('dragstart', e => {
      draggedEl = el;
      el.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', '');
    });
    el.addEventListener('dragend', () => {
      el.classList.remove('dragging');
      draggedEl = null;
      document.querySelectorAll('.tier-column, .staging-section, .staging-body').forEach(c => c.classList.remove('drag-over'));
    });
  }

  ALL_ZONES.forEach(zoneId => {
    const zone = document.getElementById(zoneId);

    zone.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const wrap = zone.closest('.tier-column') || zone.closest('.staging-section');
      if (wrap) wrap.classList.add('drag-over');
      zone.classList.add('drag-over');
    });

    zone.addEventListener('dragleave', e => {
      if (!zone.contains(e.relatedTarget)) {
        const wrap = zone.closest('.tier-column') || zone.closest('.staging-section');
        if (wrap) wrap.classList.remove('drag-over');
        zone.classList.remove('drag-over');
      }
    });

    zone.addEventListener('drop', e => {
      e.preventDefault();
      const wrap = zone.closest('.tier-column') || zone.closest('.staging-section');
      if (wrap) wrap.classList.remove('drag-over');
      zone.classList.remove('drag-over');
      if (!draggedEl) return;

      if (zone !== draggedEl.parentElement) {
        zone.appendChild(draggedEl);
      } else {
        const after = getDragAfter(zone, e.clientY);
        if (after) zone.insertBefore(draggedEl, after);
        else zone.appendChild(draggedEl);
      }
      updateCounts();
      saveState();
    });
  });

  function getDragAfter(container, y) {
    const els = [...container.querySelectorAll('.postit:not(.dragging), .tier-image:not(.dragging)')];
    let closest = { off: Infinity, el: null };
    els.forEach(child => {
      const box = child.getBoundingClientRect();
      const off = y - box.top - box.height / 2;
      if (off < 0 && -off < closest.off) closest = { off: -off, el: child };
    });
    return closest.el;
  }

  // â”€â”€ Init â”€â”€
  loadState();
})();
</script>
</body>
</html>
